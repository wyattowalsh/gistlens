# Auth.js Configuration

GistLens uses **Auth.js** (formerly NextAuth.js v5) for secure GitHub OAuth authentication with server-side secret management.

## Overview

Auth.js is the official rebrand of NextAuth.js v5. While the package name remains `next-auth`, the official documentation is at [authjs.dev](https://authjs.dev).

### Key Features

- âœ… Server-side secret management
- âœ… Encrypted JWT sessions
- âœ… Database-backed user persistence
- âœ… Automatic token refresh
- âœ… CSRF protection
- âœ… GitHub OAuth integration

## Architecture

### Authentication Flow

1. User clicks "Sign in with GitHub"
2. Redirected to GitHub OAuth page
3. User authorizes application
4. GitHub redirects to callback URL
5. Server exchanges code for access token (server-side only)
6. User created/updated in PostgreSQL database
7. Encrypted JWT session stored
8. User redirected to application

## Configuration Files

### `lib/auth/config.ts`

Main Auth.js configuration with GitHub provider:

```typescript
import NextAuth from 'next-auth';
import GitHub from 'next-auth/providers/github';
import type { NextAuthConfig } from 'next-auth';
import { createUser, getUserByGithubId } from '@/lib/db';

export const authConfig: NextAuthConfig = {
  providers: [
    GitHub({
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
      authorization: {
        params: {
          scope: 'gist user:email',
        },
      },
    }),
  ],
  callbacks: {
    async signIn({ user, account, profile }) {
      if (account?.provider === 'github' && profile) {
        // Create or update user in database
        await createUser({
          githubId: profile.id as string,
          username: profile.login as string,
          email: profile.email as string | null,
          avatarUrl: profile.avatar_url as string | null,
        });
      }
      return true;
    },
    async jwt({ token, account, profile }) {
      // Persist GitHub access token to JWT
      if (account && profile) {
        token.accessToken = account.access_token;
        token.githubId = profile.id;
      }
      return token;
    },
    async session({ session, token }) {
      // Add access token to session for API calls
      if (token) {
        session.accessToken = token.accessToken as string;
        session.user.githubId = token.githubId as string;
      }
      return session;
    },
  },
  pages: {
    signIn: '/auth/signin',
    error: '/auth/error',
  },
  session: {
    strategy: 'jwt',
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },
};

export const { handlers, auth, signIn, signOut } = NextAuth(authConfig);
```

### `app/api/auth/[...nextauth]/route.ts`

API route handler for Auth.js:

```typescript
import { handlers } from '@/lib/auth/config';

export const { GET, POST } = handlers;
```

### `types/next-auth.d.ts`

TypeScript type extensions:

```typescript
import 'next-auth';
import 'next-auth/jwt';

declare module 'next-auth' {
  interface Session {
    accessToken?: string;
    user: {
      id: string;
      githubId: string;
      name?: string | null;
      email?: string | null;
      image?: string | null;
    };
  }
}

declare module 'next-auth/jwt' {
  interface JWT {
    accessToken?: string;
    githubId?: string;
  }
}
```

## Environment Variables

Add these to your `.env.local`:

```env
# Auth.js Configuration
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="generate-with-openssl-rand-base64-32"

# GitHub OAuth
GITHUB_CLIENT_ID="your-client-id"
GITHUB_CLIENT_SECRET="your-client-secret"
GITHUB_REDIRECT_URI="http://localhost:3000/api/auth/callback/github"
```

Generate `NEXTAUTH_SECRET`:

```bash
openssl rand -base64 32
```

## Usage in Components

### Server Components

```typescript
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';

export default async function ProtectedPage() {
  const session = await auth();
  
  if (!session) {
    redirect('/api/auth/signin');
  }
  
  return (
    <div>
      <h1>Welcome, {session.user?.name}</h1>
      <p>GitHub ID: {session.user?.githubId}</p>
    </div>
  );
}
```

### Client Components

```typescript
'use client';

import { useSession, signIn, signOut } from 'next-auth/react';

export function UserProfile() {
  const { data: session, status } = useSession();
  
  if (status === 'loading') {
    return <div>Loading...</div>;
  }
  
  if (!session) {
    return (
      <button onClick={() => signIn('github')}>
        Sign in with GitHub
      </button>
    );
  }
  
  return (
    <div>
      <img src={session.user?.image} alt="Avatar" />
      <p>{session.user?.name}</p>
      <button onClick={() => signOut()}>Sign out</button>
    </div>
  );
}
```

### Root Layout (Required for Client Components)

```typescript
import { SessionProvider } from 'next-auth/react';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <SessionProvider>
          {children}
        </SessionProvider>
      </body>
    </html>
  );
}
```

## API Routes with Auth

### Authenticated API Call

```typescript
import { auth } from '@/lib/auth';
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  const session = await auth();
  
  if (!session?.accessToken) {
    return NextResponse.json(
      { error: 'Unauthorized' },
      { status: 401 }
    );
  }
  
  // Use GitHub token for API calls
  const response = await fetch('https://api.github.com/gists', {
    headers: {
      'Authorization': `Bearer ${session.accessToken}`,
      'Accept': 'application/vnd.github+json',
    },
  });
  
  const gists = await response.json();
  return NextResponse.json(gists);
}
```

## Sign In/Out Methods

### Programmatic Sign In

```typescript
import { signIn } from 'next-auth/react';

// Sign in with GitHub
await signIn('github');

// Sign in with redirect to specific page
await signIn('github', { callbackUrl: '/dashboard' });
```

### Programmatic Sign Out

```typescript
import { signOut } from 'next-auth/react';

// Sign out
await signOut();

// Sign out with redirect
await signOut({ callbackUrl: '/' });
```

## Security Features

### Server-Side Secrets

- âœ… **Client secret never sent to browser**
- âœ… Stored in `.env.local` (server-side only)
- âœ… Only accessible in API routes and Server Components

### Encrypted Sessions

- âœ… JWT tokens encrypted with `NEXTAUTH_SECRET`
- âœ… Tokens signed to prevent tampering
- âœ… Automatic expiration (30 days default)

### CSRF Protection

- âœ… Built-in CSRF token validation
- âœ… Automatic token generation and verification
- âœ… Protection for all authentication endpoints

### Database Sessions

- âœ… User data persisted in PostgreSQL
- âœ… Session information stored securely
- âœ… OAuth account linking

## GitHub OAuth Setup

### Create OAuth App

1. Go to [GitHub Settings â†’ Developer settings â†’ OAuth Apps](https://github.com/settings/developers)
2. Click "New OAuth App"
3. Fill in the details:
   - **Application name**: GistLens
   - **Homepage URL**: `http://localhost:3000` (or your domain)
   - **Authorization callback URL**: `http://localhost:3000/api/auth/callback/github`
4. Click "Register application"
5. Copy the **Client ID**
6. Click "Generate a new client secret"
7. Copy the **Client Secret**

### Configure Scopes

GistLens requests the following scopes:

- `gist` - Full access to gists (read and write)
- `user:email` - Access to user email address

### Update Environment Variables

Add the credentials to `.env.local`:

```env
GITHUB_CLIENT_ID="your-client-id-here"
GITHUB_CLIENT_SECRET="your-client-secret-here"
```

## Troubleshooting

### "Invalid client_secret"

- Verify `GITHUB_CLIENT_SECRET` is correct
- Regenerate secret in GitHub if needed
- Ensure no trailing spaces in `.env.local`

### "Callback URL mismatch"

- Verify callback URL in GitHub app settings matches:
  - Local: `http://localhost:3000/api/auth/callback/github`
  - Production: `https://yourdomain.com/api/auth/callback/github`

### Session Not Persisting

- Ensure `NEXTAUTH_SECRET` is set
- Check that cookies are enabled in browser
- Verify `NEXTAUTH_URL` matches your current URL

### "Database connection failed"

- Check PostgreSQL connection string
- Verify database schema is created
- Test connection with: `psql $POSTGRES_URL -c "SELECT 1;"`

## Learn More

- [Official Auth.js Documentation](https://authjs.dev)
- [GitHub OAuth Documentation](https://docs.github.com/en/apps/oauth-apps)
- [Next.js Authentication](https://nextjs.org/docs/authentication)

## Next Steps

- [Explore Database Schema](/database)
- [Use GitHub API Routes](/api)
- [Deploy to Production](/deployment)

---

Your authentication is now fully configured and secure! ðŸ”’
